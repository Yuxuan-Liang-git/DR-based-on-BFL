# 航位推算思路

* 根据方向盘转角和车速推算航位

  效果不佳。可能的原因如下：

1.  表对应的转向比不准，在原点正负十度内基本不准，猜测是转向系统虚位
2.  动静态表对应的转向比有问题，静态的转向比要比10km/h时的转向比要小（理论上来说应该随速度上升，车辆侧滑越严重，转向越不灵敏？）
3.  查表的方式有问题（试过分档位模糊查表，0～10一档，10～20一档，etc.）(试过线形插值，例如5km/h下就取静止和10km/h下的转向比加权求中值)

* 单独用yaw_rate和车速积分

  效果较好，上了卡尔曼滤波平滑后的效果也还可以，但是用卡罗拉的数据出来就很差。说明不同车辆返回yaw_rate的精度不一，很难说通用。考虑综合其他数据一同滤波。

* 用IMU和方向盘转角做卡尔曼滤波，方向盘推算的航位值当成预测量，IMU作为观测量修正

  有一定效果，但没有想像中的那么好，改换bfl库出来的效果也是一样。

* 将转向比也作为状态量代入卡尔曼滤波中

  转向比是个三角函数，雅可比矩阵算出来比较复杂，暂时搁置了这个方法。

* 将方向盘转角**等转向比**推出来的yaw_rate作为一个新的传感器，用两个传感器同时观测同一个yaw_rate的方式融合出相对准确的yaw_rate。
  尝试效果比较好，但是两者数据融合的方式是根据各自的卡尔曼增益进行线性加权，卡尔曼增益可能会收敛到常数，对应的权重也会收敛到常数。初始协方差对滤波效果有很大影响，该权重可能会出现负值。该方法线性加权后的数据波动程度反而可能会比原有的两者更剧烈（权重在变化）。
  该方法用卡罗拉的数据出来的效果就不行。



以上状态量均为坐标值，传感器数据都转为航位值后才进行卡尔曼滤波。后续代码重构，直接将传感器值作为状态量预测与观测。

* 切换模式，利用定位更新坐标

  **暂时没弄**

* 引入IMU数据以修正速度与yaw_rate

  **需等杜思源实现重力矫正才能使用**

* 侧向加速度修正后对yaw_rate进行修正

  汽车侧倾会对侧向加速度产生影响，需要修正。侧倾角$\phi=k_{\phi}a_y$，侧倾角增益$k_{\phi}$近似为$0.12rad/g_n$。则侧向加速度的测量值为
  $$
  a_{y}^{mea}=a_ycos(\phi)+gsin(\phi)=a_y+g\phi=(1+gk_{\phi})a_y
  $$
  修正后的侧向加速度为
  $$
  a_y=\frac{a_{y}^{mea}}{1+gk_{\phi}}
  $$
  其中$g$为重力加速度，，即实际侧向加速度为测量加速度/1.12。
  
  结果是不太行，用侧向加速度计算出来的yaw_rate波动太剧烈，可能起反作用...不如不加。
  
  ![image-20230410165307910](./assets/image-20230410165307910.png)

* 引入GPS信号修正航位

  ![position](./assets/position.jpg)

将GPS轨迹对齐至路径图中，轨迹其实还行，但是GPS信号太少了，看不出效果。GPS、IMU、底盘数据更新频率不一致，需要研究怎么做融合。
